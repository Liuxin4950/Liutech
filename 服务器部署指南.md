# LiuTech 服务器部署指南

## 概述
本指南将帮助你将本地构建的 Docker 镜像部署到远程服务器上。

## 部署方式对比

### 方式一：镜像传输部署（推荐用于小规模部署）
**优点：**
- 简单直接，适合快速部署
- 不需要在服务器上重新构建
- 保证本地和服务器环境一致

**缺点：**
- 镜像文件较大，传输时间长
- 每次更新都需要重新传输完整镜像

### 方式二：源码部署（推荐用于生产环境）
**优点：**
- 传输文件小，只需传输源码
- 便于版本管理和持续集成
- 可以针对服务器环境优化构建

**缺点：**
- 需要在服务器上安装构建环境
- 构建时间较长

## 方式一：镜像传输部署

### 1. 本地准备工作（已完成）
```bash
# 导出镜像文件
docker save -o liutech-backend.tar liutech-backend:latest
docker save -o liutech-web.tar liutech-web:latest  
docker save -o liutech-admin.tar liutech-admin:latest
```

**当前镜像文件大小：**
- liutech-backend.tar: ~296MB
- liutech-web.tar: ~77MB
- liutech-admin.tar: ~26MB
- 总计: ~399MB

### 2. 传输文件到服务器
```bash
# 使用 scp 传输（替换为你的服务器信息）
scp *.tar username@your-server-ip:/path/to/deployment/
scp docker-compose.yml username@your-server-ip:/path/to/deployment/
scp -r nginx/ username@your-server-ip:/path/to/deployment/
scp sql.sql username@your-server-ip:/path/to/deployment/
```

### 3. 服务器端操作

#### 3.1 安装 Docker 和 Docker Compose（如果未安装）
```bash
# Ubuntu/Debian
sudo apt update
sudo apt install docker.io docker-compose

# CentOS/RHEL
sudo yum install docker docker-compose

# 启动 Docker 服务
sudo systemctl start docker
sudo systemctl enable docker
```

#### 3.2 导入镜像
```bash
# 进入部署目录
cd /path/to/deployment/

# 导入镜像
docker load -i liutech-backend.tar
docker load -i liutech-web.tar
docker load -i liutech-admin.tar

# 验证镜像导入
docker images | grep liutech
```

#### 3.3 配置环境
```bash
# 创建必要的目录
mkdir -p logs uploads

# 设置权限
sudo chown -R 1000:1000 logs uploads
```

#### 3.4 启动服务
```bash
# 启动所有服务
docker-compose up -d

# 查看服务状态
docker-compose ps

# 查看日志
docker-compose logs -f
```

---

## 命令详解（逐条解释）

以下对常用命令进行“可读性”拆解，便于理解每一步在做什么：

```bash
docker-compose up --build -d
```
- `up`：根据 `docker-compose.yml` 创建并启动所有服务。
- `--build`：先为包含 `build:` 的服务重新构建镜像（前端与后端）。代码改动后必须带它。
- `-d`：后台运行（不占用当前终端）。

```bash
docker-compose ps
```
- 列出当前编排中各服务的容器状态（`Up` 表示运行中）。

```bash
docker-compose logs -f backend
```
- 输出指定服务（这里是后端）的实时日志，`-f` 表示跟随输出；用于快速定位接口异常。

```bash
docker-compose restart nginx
```
- 重启某个服务的容器，不会重建镜像。用于热重载 Nginx 或后端配置变更。

```bash
docker-compose down
```
- 停止并移除所有容器与网络，镜像保留。用于清理环境或重新启动。

```bash
docker load -i liutech-backend.tar
```
- 从 `.tar` 文件导入镜像到服务器本地镜像库。通常用于“本地构建、远程导入”的部署模式。

```bash
docker images
```
- 查看本地镜像列表，确认 `liutech-*` 镜像是否存在、标签是否正确（常见为 `latest`）。

```bash
docker exec -it backend sh
```
- 进入某个容器的交互式终端（这里是后端容器），用于检查容器内文件、配置或临时排错。

---

## Windows 传输与环境说明

- `scp` 来自 OpenSSH；在 Windows 10/11 通常已内置，若报“命令不存在”，可在“设置 → 应用 → 可选功能”安装“OpenSSH 客户端”。
- 如果你习惯可视化工具，可使用 WinSCP（拖拽即可传输）。命令行与图形工具任选其一即可。
- 也可用 `PowerShell` 压缩后再传输：

```powershell
# 在本地打包部署材料（示例）
Compress-Archive -Path liutech-*.tar, docker-compose.yml, nginx -DestinationPath deploy.zip

# 传输（需安装 scp）
scp deploy.zip username@your-server-ip:/path/to/deployment/
```

---

## 一步一步（服务器侧）操作手册

1. 登录服务器，进入部署目录：
   ```bash
   cd /path/to/deployment/
   ```
2. 导入镜像、检查是否存在：
   ```bash
   docker load -i liutech-backend.tar
   docker load -i liutech-web.tar
   docker load -i liutech-admin.tar
   docker images | grep liutech
   ```
3. 启动所有服务并查看状态：
   ```bash
   docker-compose up --build -d
   docker-compose ps
   ```
4. 验证访问与日志：
   ```bash
   # 日志
   docker-compose logs -f nginx
   docker-compose logs -f backend
   
   # 访问
   # Web:   http://<服务器IP或域名>
   # Admin: http://admin.<服务器域名或使用 admin.localhost 做本地测试>
   ```
5. 如需停止并清理：
   ```bash
   docker-compose down
   ```

---

## 更新与回滚建议

- 小版本更新（代码改动不涉及数据库结构）：
  ```bash
  # 本地重建镜像并导出；服务器导入后：
  docker-compose up -d --build
  ```

- 回滚到上一版本：保留旧镜像 `.tar`，在服务器上重新 `docker load -i old.tar` 后 `docker-compose up -d`。

- 数据持久化：把上传目录映射到宿主机，避免容器销毁导致数据丢失：
  ```yaml
  services:
    backend:
      volumes:
        - ./uploads:/app/uploads
  ```

---

## 速查表（一屏掌握）

- 启动并重建：`docker-compose up --build -d`
- 查看状态：`docker-compose ps`
- 看日志：`docker-compose logs -f [service]`
- 重启服务：`docker-compose restart [service]`
- 停止清理：`docker-compose down`
- 导入镜像：`docker load -i <image>.tar`
- 列镜像：`docker images`
- 进容器：`docker exec -it <service> sh`

---

## FAQ（常见疑问）

1. 为什么浏览器不能访问 `backend:8080`？
   - 这是容器内部网络主机名，浏览器无法解析。请统一走同域 `/api`，由根 Nginx 反向代理。
2. 改了端口后要改哪里？
   - 修改根 `.env`（如 `NGINX_HTTP`、`BACKEND_PORT` 等），然后 `docker-compose up --build -d`。
3. 构建失败说找不到 JAR？
   - 需要先在后端执行 `mvn clean package -DskipTests`，确保 `target/liutech-backend-*.jar` 存在。
4. 如何备份数据？
   - 数据库：`docker-compose exec mysql mysqldump -u root -p liutech > backup.sql`
   - 上传目录：`tar -czf uploads-backup.tar.gz uploads/`

## 方式二：源码部署

### 1. 传输源码到服务器
```bash
# 压缩项目文件（排除不必要的文件）
tar -czf liutech-project.tar.gz \
  --exclude=node_modules \
  --exclude=target \
  --exclude=dist \
  --exclude=.git \
  --exclude=*.tar \
  .

# 传输到服务器
scp liutech-project.tar.gz username@your-server-ip:/path/to/deployment/
```

### 2. 服务器端构建和部署
```bash
# 解压项目
cd /path/to/deployment/
tar -xzf liutech-project.tar.gz

# 安装构建环境
# Java 21
sudo apt install openjdk-21-jdk

# Node.js 20
curl -fsSL https://deb.nodesource.com/setup_20.x | sudo -E bash -
sudo apt-get install -y nodejs

# Maven
sudo apt install maven

# 构建并启动
docker-compose up --build -d
```

## 服务器配置要求

### 最低配置
- CPU: 2核
- 内存: 4GB
- 存储: 20GB
- 网络: 10Mbps

### 推荐配置
- CPU: 4核
- 内存: 8GB
- 存储: 50GB
- 网络: 100Mbps

## 端口配置

确保服务器防火墙开放以下端口：
- 80: HTTP (Nginx)
- 443: HTTPS (Nginx)
- 3000: Web前端（可选，如果需要直接访问）
- 3001: Admin后台（可选，如果需要直接访问）
- 8080: 后端API（可选，如果需要直接访问）

```bash
# Ubuntu/Debian 防火墙配置
sudo ufw allow 80
sudo ufw allow 443
sudo ufw enable

# CentOS/RHEL 防火墙配置
sudo firewall-cmd --permanent --add-port=80/tcp
sudo firewall-cmd --permanent --add-port=443/tcp
sudo firewall-cmd --reload
```

## 数据库配置

### 使用 Docker MySQL（推荐）
docker-compose.yml 中已包含 MySQL 配置，会自动创建数据库。

### 使用外部数据库
如果使用外部数据库，需要修改 docker-compose.yml 中的数据库连接配置：

```yaml
environment:
  - SPRING_DATASOURCE_URL=jdbc:mysql://your-db-host:3306/liutech
  - SPRING_DATASOURCE_USERNAME=your-username
  - SPRING_DATASOURCE_PASSWORD=your-password
```

## 域名和SSL配置

### 1. 域名解析
将你的域名 A 记录指向服务器 IP 地址。

### 2. SSL 证书配置
```bash
# 安装 Certbot
sudo apt install certbot python3-certbot-nginx

# 获取 SSL 证书
sudo certbot --nginx -d your-domain.com

# 自动续期
sudo crontab -e
# 添加：0 12 * * * /usr/bin/certbot renew --quiet
```

## 监控和维护

### 查看服务状态
```bash
docker-compose ps
docker-compose logs -f [service-name]
```

### 更新部署
```bash
# 停止服务
docker-compose down

# 更新镜像（方式一）
docker load -i new-image.tar

# 或重新构建（方式二）
docker-compose build

# 启动服务
docker-compose up -d
```

### 备份数据
```bash
# 备份数据库
docker-compose exec mysql mysqldump -u root -p liutech > backup.sql

# 备份上传文件
tar -czf uploads-backup.tar.gz uploads/
```

## 故障排除

### 常见问题
1. **端口被占用**：检查防火墙和其他服务
2. **内存不足**：增加服务器内存或优化 JVM 参数
3. **数据库连接失败**：检查数据库配置和网络连接
4. **镜像导入失败**：检查磁盘空间和文件完整性

### 日志查看
```bash
# 查看所有服务日志
docker-compose logs

# 查看特定服务日志
docker-compose logs backend
docker-compose logs web
docker-compose logs admin
```

## 性能优化

### JVM 参数优化
在 docker-compose.yml 中添加：
```yaml
environment:
  - JAVA_OPTS=-Xms512m -Xmx2g -XX:+UseG1GC
```

### Nginx 优化
修改 nginx/nginx.conf 配置文件，优化缓存和压缩设置。

---

**注意事项：**
1. 首次部署建议使用方式一（镜像传输），后续更新可考虑方式二
2. 生产环境建议使用外部数据库和文件存储
3. 定期备份数据和配置文件
4. 监控服务器资源使用情况