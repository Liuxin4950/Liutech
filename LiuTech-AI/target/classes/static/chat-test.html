<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AIèŠå¤©æµ‹è¯• - é“¶æœˆåŠ©æ‰‹</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Microsoft YaHei', Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            overflow: hidden;
        }
        
        .header {
            background: linear-gradient(45deg, #4a90e2, #7b68ee);
            color: white;
            padding: 20px;
            text-align: center;
        }
        
        .header h1 {
            margin-bottom: 10px;
            font-size: 24px;
        }
        
        .header p {
            opacity: 0.9;
            font-size: 14px;
        }
        
        .chat-container {
            height: 400px;
            overflow-y: auto;
            padding: 20px;
            background: #f8f9fa;
        }
        
        .message {
            margin-bottom: 15px;
            display: flex;
            align-items: flex-start;
        }
        
        .message.user {
            justify-content: flex-end;
        }
        
        .message-content {
            max-width: 70%;
            padding: 12px 16px;
            border-radius: 18px;
            word-wrap: break-word;
        }
        
        .message.user .message-content {
            background: #4a90e2;
            color: white;
        }
        
        .message.ai .message-content {
            background: white;
            border: 1px solid #e1e5e9;
            color: #333;
        }
        
        .message-info {
            font-size: 12px;
            color: #666;
            margin-top: 5px;
        }
        
        .input-area {
            padding: 20px;
            border-top: 1px solid #e1e5e9;
        }
        
        .input-group {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
        }
        
        .input-group input {
            flex: 1;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 8px;
            font-size: 14px;
        }
        
        .input-group button {
            padding: 12px 20px;
            background: #4a90e2;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            transition: background 0.3s;
        }
        
        .input-group button:hover {
            background: #357abd;
        }
        
        .input-group button:disabled {
            background: #ccc;
            cursor: not-allowed;
        }
        
        .controls {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }
        
        .controls button {
            padding: 8px 16px;
            border: 1px solid #ddd;
            background: white;
            border-radius: 6px;
            cursor: pointer;
            font-size: 12px;
            transition: all 0.3s;
        }
        
        .controls button:hover {
            background: #f0f0f0;
        }
        
        .controls button.active {
            background: #4a90e2;
            color: white;
            border-color: #4a90e2;
        }
        
        .status {
            padding: 10px;
            background: #e8f4fd;
            border-left: 4px solid #4a90e2;
            margin-bottom: 15px;
            font-size: 14px;
        }
        
        .typing {
            display: none;
            color: #666;
            font-style: italic;
            padding: 10px 16px;
        }
        
        .typing.show {
            display: block;
        }
        
        .session-info {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            padding: 10px;
            border-radius: 6px;
            margin-bottom: 15px;
            font-size: 12px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸŒ™ é“¶æœˆAIèŠå¤©æµ‹è¯• - ç®€åŒ–ç‰ˆ</h1>
            <p>åŸºäºç”¨æˆ·IDçš„è®°å¿†ç®¡ç†</p>
        </div>
        
        <div class="session-info">
            <strong>ç”¨æˆ·ID:</strong> <span id="sessionId">æœªè®¾ç½®</span> |
            <strong>å†å²æ¶ˆæ¯:</strong> <span id="historyCount">0</span> æ¡ |
            <strong>æ¨¡å¼:</strong> <span id="currentMode">æ™®é€šæ¨¡å¼</span>
        </div>
        
        <div class="status" id="status">
            å‡†å¤‡å°±ç»ªï¼Œå¯ä»¥å¼€å§‹èŠå¤©äº†ï½
        </div>
        
        <div class="chat-container" id="chatContainer">
            <div class="message ai">
                <div class="message-content">
                    ä½ å¥½ï¼æˆ‘æ˜¯é“¶æœˆï¼Œä½ çš„AIåŠ©æ‰‹ï½ ç°åœ¨æ”¯æŒæµå¼è¾“å‡ºå’Œä¼šè¯è®°å¿†åŠŸèƒ½å•¦ï¼
                    <div class="message-info">ç³»ç»Ÿæ¶ˆæ¯</div>
                </div>
            </div>
        </div>
        
        <div class="typing" id="typing">é“¶æœˆæ­£åœ¨æ€è€ƒä¸­...</div>
        
        <div class="input-area">
            <div class="input-group">
                <input type="text" id="messageInput" placeholder="è¾“å…¥ä½ çš„æ¶ˆæ¯..." maxlength="500">
                <button id="sendBtn" onclick="sendMessage()">å‘é€</button>
            </div>
            
            <div class="controls">
                <button id="normalMode" class="active" onclick="setMode('normal')">æ™®é€šæ¨¡å¼</button>
                <button id="streamMode" onclick="setMode('stream')">æµå¼æ¨¡å¼</button>
                <button onclick="clearSession()">æ¸…ç†è®°å¿†</button>
                <button onclick="getStats()">æŸ¥çœ‹ç»Ÿè®¡</button>
                <button onclick="clearChat()">æ¸…ç©ºèŠå¤©</button>
            </div>
        </div>
    </div>

    <script>
        // å…¨å±€å˜é‡
        let currentUserId = 'user_001'; // é»˜è®¤ç”¨æˆ·ID
        let currentMode = 'normal'; // normal æˆ– stream
        let isProcessing = false;
        
        // é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            // å›è½¦å‘é€æ¶ˆæ¯
            document.getElementById('messageInput').addEventListener('keypress', function(e) {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    sendMessage();
                }
            });
            
            updateUserInfo();
        });
        
        // æ›´æ–°ç”¨æˆ·ä¿¡æ¯æ˜¾ç¤º
        function updateUserInfo() {
            document.getElementById('sessionId').textContent = currentUserId || 'æœªè®¾ç½®';
            document.getElementById('currentMode').textContent = currentMode === 'stream' ? 'æµå¼æ¨¡å¼' : 'æ™®é€šæ¨¡å¼';
        }
        
        // è®¾ç½®èŠå¤©æ¨¡å¼
        function setMode(mode) {
            currentMode = mode;
            
            // æ›´æ–°æŒ‰é’®çŠ¶æ€
            document.getElementById('normalMode').classList.toggle('active', mode === 'normal');
            document.getElementById('streamMode').classList.toggle('active', mode === 'stream');
            
            updateUserInfo();
            updateStatus(`å·²åˆ‡æ¢åˆ°${mode === 'stream' ? 'æµå¼' : 'æ™®é€š'}æ¨¡å¼`);
        }
        
        // å‘é€æ¶ˆæ¯
        async function sendMessage() {
            const input = document.getElementById('messageInput');
            const message = input.value.trim();
            
            if (!message || isProcessing) return;
            
            // æ·»åŠ ç”¨æˆ·æ¶ˆæ¯åˆ°ç•Œé¢
            addMessage('user', message);
            input.value = '';
            
            isProcessing = true;
            updateSendButton(true);
            
            try {
                if (currentMode === 'stream') {
                    await sendStreamMessage(message);
                } else {
                    await sendNormalMessage(message);
                }
            } catch (error) {
                console.error('å‘é€æ¶ˆæ¯å¤±è´¥:', error);
                updateStatus('å‘é€å¤±è´¥: ' + error.message);
                addMessage('ai', 'æŠ±æ­‰ï¼Œå‘é€æ¶ˆæ¯æ—¶å‡ºç°äº†é”™è¯¯: ' + error.message);
            } finally {
                isProcessing = false;
                updateSendButton(false);
                hideTyping();
            }
        }
        
        // å‘é€æ™®é€šæ¶ˆæ¯
        async function sendNormalMessage(message) {
            showTyping();
            updateStatus('æ­£åœ¨å¤„ç†æ¶ˆæ¯...');
            
            const response = await fetch('/api/ai/chat', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    message: message,
                    userId: currentUserId
                })
            });
            
            const data = await response.json();
            
            if (data.success) {
                addMessage('ai', data.data.message);
                currentUserId = data.data.userId;
                document.getElementById('historyCount').textContent = data.data.historyCount || 0;
                updateStatus('æ¶ˆæ¯å¤„ç†å®Œæˆ');
            } else {
                addMessage('ai', 'é”™è¯¯: ' + data.message);
                updateStatus('å¤„ç†å¤±è´¥: ' + data.message);
            }
            
            updateUserInfo();
        }
        
        // å‘é€æµå¼æ¶ˆæ¯
        async function sendStreamMessage(message) {
            showTyping();
            updateStatus('å»ºç«‹æµå¼è¿æ¥...');
            
            const response = await fetch('/api/ai/chat/stream', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    message: message,
                    userId: currentUserId
                })
            });
            
            if (!response.ok) {
                throw new Error('ç½‘ç»œè¯·æ±‚å¤±è´¥: ' + response.status);
            }
            
            const reader = response.body.getReader();
            const decoder = new TextDecoder();
            
            let aiMessageElement = null;
            let fullResponse = '';
            
            try {
                while (true) {
                    const { done, value } = await reader.read();
                    if (done) break;
                    
                    const chunk = decoder.decode(value);
                    const lines = chunk.split('\n');
                    
                    for (const line of lines) {
                        if (line.startsWith('data: ')) {
                            try {
                                const eventData = JSON.parse(line.slice(6));
                                await handleStreamEvent(eventData, (element, response) => {
                                    aiMessageElement = element;
                                    fullResponse = response;
                                });
                            } catch (e) {
                                console.warn('è§£æSSEæ•°æ®å¤±è´¥:', line, e);
                            }
                        }
                    }
                }
            } finally {
                reader.releaseLock();
            }
            
            updateStatus('æµå¼å“åº”å®Œæˆ');
        }
        
        // å¤„ç†æµå¼äº‹ä»¶
        async function handleStreamEvent(eventData, callback) {
            if (eventData.sessionId) {
                currentSessionId = eventData.sessionId;
                updateSessionInfo();
            }
            
            if (eventData.message === 'AIæ­£åœ¨æ€è€ƒä¸­...') {
                updateStatus('AIæ­£åœ¨æ€è€ƒä¸­...');
                if (eventData.historyCount !== undefined) {
                    document.getElementById('historyCount').textContent = eventData.historyCount;
                }
            }
            
            if (eventData.chunk) {
                // å¦‚æœè¿˜æ²¡æœ‰AIæ¶ˆæ¯å…ƒç´ ï¼Œåˆ›å»ºä¸€ä¸ª
                let aiMessageElement = document.querySelector('.message.ai:last-child .message-content');
                if (!aiMessageElement || aiMessageElement.dataset.completed === 'true') {
                    const messageDiv = addMessage('ai', '');
                    aiMessageElement = messageDiv.querySelector('.message-content');
                }
                
                // è¿½åŠ æ–‡æœ¬å—
                const currentText = aiMessageElement.childNodes[0]?.textContent || '';
                const newText = currentText + eventData.chunk;
                aiMessageElement.childNodes[0].textContent = newText;
                
                // æ»šåŠ¨åˆ°åº•éƒ¨
                scrollToBottom();
                
                callback(aiMessageElement, newText);
            }
            
            if (eventData.success && eventData.totalLength !== undefined) {
                // æ ‡è®°æ¶ˆæ¯å®Œæˆ
                const aiMessageElement = document.querySelector('.message.ai:last-child .message-content');
                if (aiMessageElement) {
                    aiMessageElement.dataset.completed = 'true';
                    
                    // æ·»åŠ æ¶ˆæ¯ä¿¡æ¯
                    const infoDiv = document.createElement('div');
                    infoDiv.className = 'message-info';
                    infoDiv.textContent = `æµå¼å“åº” - ${eventData.totalLength} å­—ç¬¦`;
                    aiMessageElement.appendChild(infoDiv);
                }
                
                updateStatus(`æµå¼å“åº”å®Œæˆ (${eventData.totalLength} å­—ç¬¦)`);
            }
            
            if (!eventData.success && eventData.message) {
                addMessage('ai', 'é”™è¯¯: ' + eventData.message);
                updateStatus('æµå¼å“åº”å¤±è´¥: ' + eventData.message);
            }
        }
        
        // æ·»åŠ æ¶ˆæ¯åˆ°èŠå¤©ç•Œé¢
        function addMessage(type, content) {
            const chatContainer = document.getElementById('chatContainer');
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${type}`;
            
            const contentDiv = document.createElement('div');
            contentDiv.className = 'message-content';
            contentDiv.textContent = content;
            
            // æ·»åŠ æ—¶é—´ä¿¡æ¯
            const infoDiv = document.createElement('div');
            infoDiv.className = 'message-info';
            infoDiv.textContent = new Date().toLocaleTimeString();
            contentDiv.appendChild(infoDiv);
            
            messageDiv.appendChild(contentDiv);
            chatContainer.appendChild(messageDiv);
            
            scrollToBottom();
            return messageDiv;
        }
        
        // æ»šåŠ¨åˆ°åº•éƒ¨
        function scrollToBottom() {
            const chatContainer = document.getElementById('chatContainer');
            chatContainer.scrollTop = chatContainer.scrollHeight;
        }
        
        // æ˜¾ç¤º/éšè—è¾“å…¥çŠ¶æ€
        function showTyping() {
            document.getElementById('typing').classList.add('show');
        }
        
        function hideTyping() {
            document.getElementById('typing').classList.remove('show');
        }
        
        // æ›´æ–°å‘é€æŒ‰é’®çŠ¶æ€
        function updateSendButton(disabled) {
            const sendBtn = document.getElementById('sendBtn');
            sendBtn.disabled = disabled;
            sendBtn.textContent = disabled ? 'å‘é€ä¸­...' : 'å‘é€';
        }
        
        // æ›´æ–°çŠ¶æ€ä¿¡æ¯
        function updateStatus(message) {
            document.getElementById('status').textContent = message;
        }
        
        // æ¸…ç†ç”¨æˆ·è®°å¿†
        async function clearSession() {
            if (!currentUserId) return;
            
            try {
                const response = await fetch(`/api/ai/chat/user/${currentUserId}`, {
                    method: 'DELETE'
                });
                
                const data = await response.json();
                
                if (data.success) {
                    updateStatus('ç”¨æˆ·è®°å¿†å·²æ¸…ç†');
                    document.getElementById('historyCount').textContent = '0';
                    updateUserInfo();
                } else {
                    updateStatus('æ¸…ç†å¤±è´¥: ' + data.message);
                }
            } catch (error) {
                console.error('æ¸…ç†ç”¨æˆ·è®°å¿†å¤±è´¥:', error);
                updateStatus('æ¸…ç†å¤±è´¥: ' + error.message);
            }
        }
        
        // è·å–ç»Ÿè®¡ä¿¡æ¯
        async function getStats() {
            try {
                const response = await fetch('/api/ai/chat/stats');
                const data = await response.json();
                
                if (data.success) {
                    const stats = data.data;
                    updateStatus(`æ´»è·ƒç”¨æˆ·: ${stats.activeUserCount} ä¸ª | æœåŠ¡å™¨æ—¶é—´: ${new Date(stats.serverTime).toLocaleString()}`);
                } else {
                    updateStatus('è·å–ç»Ÿè®¡å¤±è´¥: ' + data.message);
                }
            } catch (error) {
                console.error('è·å–ç»Ÿè®¡å¤±è´¥:', error);
                updateStatus('è·å–ç»Ÿè®¡å¤±è´¥: ' + error.message);
            }
        }
        
        // æ¸…ç©ºèŠå¤©è®°å½•
        function clearChat() {
            const chatContainer = document.getElementById('chatContainer');
            chatContainer.innerHTML = `
                <div class="message ai">
                    <div class="message-content">
                        èŠå¤©è®°å½•å·²æ¸…ç©ºï¼Œä½†ç”¨æˆ·è®°å¿†ä»ç„¶ä¿ç•™ï½
                        <div class="message-info">ç³»ç»Ÿæ¶ˆæ¯</div>
                    </div>
                </div>
            `;
            updateStatus('èŠå¤©è®°å½•å·²æ¸…ç©º');
        }
    </script>
</body>
</html>