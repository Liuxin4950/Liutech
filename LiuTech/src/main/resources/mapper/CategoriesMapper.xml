<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="chat.liuxin.liutech.mapper.CategoriesMapper">

    <!-- 查询所有分类（包含文章数量） -->
    <select id="selectCategoriesWithPostCount" resultType="chat.liuxin.liutech.model.Categories">
        SELECT 
            c.id,
            c.name,
            c.description,
            COUNT(p.id) as post_count
        FROM categories c
        LEFT JOIN posts p ON c.id = p.category_id AND p.deleted_at IS NULL AND p.status = 'published'
        WHERE c.deleted_at IS NULL
        GROUP BY c.id, c.name, c.description
        ORDER BY c.name
    </select>

    <!-- 管理端分页查询分类列表 -->
    <select id="selectCategoriesForAdmin" resultType="chat.liuxin.liutech.resl.CategoryResl">
        SELECT 
            c.id,
            c.name,
            c.description,
            c.created_at,
            c.updated_at,
            c.deleted_at,
            u.username as creator_username,
            COUNT(p.id) as post_count
        FROM categories c
        LEFT JOIN users u ON c.created_by = u.id
        LEFT JOIN posts p ON c.id = p.category_id AND p.deleted_at IS NULL
        <where>
            <if test="includeDeleted == null or includeDeleted == false">
                c.deleted_at IS NULL
            </if>
            <if test="name != null and name != ''">
                AND c.name LIKE CONCAT('%', #{name}, '%')
            </if>
        </where>
        GROUP BY c.id, c.name, c.description, c.created_at, c.updated_at, c.deleted_at, u.username
        ORDER BY c.created_at DESC
        LIMIT #{offset}, #{limit}
    </select>

    <!-- 管理端查询分类总数 -->
    <select id="countCategoriesForAdmin" resultType="java.lang.Integer">
        SELECT COUNT(DISTINCT c.id)
        FROM categories c
        <where>
            <if test="includeDeleted == null or includeDeleted == false">
                c.deleted_at IS NULL
            </if>
            <if test="name != null and name != ''">
                AND c.name LIKE CONCAT('%', #{name}, '%')
            </if>
        </where>
    </select>

    <!-- 恢复已删除的分类 -->
    <update id="restoreCategoryById">
        UPDATE categories 
        SET deleted_at = NULL, updated_at = NOW() 
        WHERE id = #{id} AND deleted_at IS NOT NULL
    </update>

</mapper>