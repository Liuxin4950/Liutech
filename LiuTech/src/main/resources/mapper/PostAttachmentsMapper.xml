<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="chat.liuxin.liutech.mapper.PostAttachmentsMapper">

    <!-- 根据草稿键查询附件列表 -->
    <select id="selectByDraftKey" resultType="chat.liuxin.liutech.model.PostAttachments">
        SELECT * FROM post_attachments 
        WHERE draft_key = #{draftKey} 
        AND post_id IS NULL
        ORDER BY created_at DESC
    </select>

    <!-- 根据文章ID查询附件列表 -->
    <select id="selectByPostId" resultType="chat.liuxin.liutech.model.PostAttachments">
        SELECT * FROM post_attachments 
        WHERE post_id = #{postId}
        ORDER BY created_at DESC
    </select>

    <!-- 将草稿附件绑定到文章 -->
    <update id="bindDraftToPost">
        UPDATE post_attachments 
        SET post_id = #{postId}, updated_at = NOW()
        WHERE draft_key = #{draftKey} 
        AND post_id IS NULL
    </update>

    <!-- 查询草稿附件详细信息（关联 Resources 表） -->
    <select id="selectDraftAttachments" resultType="java.util.Map">
        SELECT 
            pa.id as attachmentId,
            pa.resource_id as resourceId,
            pa.draft_key as draftKey,
            r.name as fileName,
            r.file_url as filePath,
            r.file_url as fileUrl,
            r.points_needed as pointsNeeded,
            pa.created_at as createdTime
        FROM post_attachments pa
        LEFT JOIN resources r ON pa.resource_id = r.id
        WHERE pa.draft_key = #{draftKey}
        AND pa.post_id IS NULL
        AND r.uploader_id = #{userId}
        ORDER BY pa.created_at DESC
    </select>

    <!-- 查询文章附件详细信息（关联 Resources 表） -->
    <select id="selectPostAttachments" resultType="java.util.Map">
        SELECT 
            pa.id as attachmentId,
            pa.resource_id as resourceId,
            pa.post_id as postId,
            r.name as fileName,
            r.file_url as filePath,
            r.file_url as fileUrl,
            r.points_needed as pointsNeeded,
            pa.created_at as createdTime
        FROM post_attachments pa
        LEFT JOIN resources r ON pa.resource_id = r.id
        WHERE pa.post_id = #{postId}
        AND r.uploader_id = #{userId}
        ORDER BY pa.created_at DESC
    </select>

    <!-- 查询文章附件详细信息（公开，不限制上传者，供前台详情展示） -->
    <select id="selectPostAttachmentsPublic" resultType="java.util.Map">
        SELECT 
            pa.id as attachmentId,
            pa.resource_id as resourceId,
            pa.post_id as postId,
            r.name as fileName,
            r.file_url as filePath,
            r.file_url as fileUrl,
            r.points_needed as pointsNeeded,
            pa.created_at as createdTime
        FROM post_attachments pa
        LEFT JOIN resources r ON pa.resource_id = r.id
        WHERE pa.post_id = #{postId}
        ORDER BY pa.created_at DESC
    </select>

    <!-- 根据资源ID删除附件关联记录 -->
    <delete id="deleteByResourceId">
        DELETE FROM post_attachments 
        WHERE resource_id = #{resourceId}
    </delete>

</mapper>