<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="chat.liuxin.liutech.mapper.PostsMapper">

    <!-- Posts实体结果映射 -->
    <resultMap id="PostWithDetailsMap" type="chat.liuxin.liutech.model.Posts">
        <id property="id" column="id"/>
        <result property="title" column="title"/>
        <result property="content" column="content"/>
        <result property="summary" column="summary"/>
        <result property="categoryId" column="category_id"/>
        <result property="authorId" column="author_id"/>
        <result property="status" column="status"/>
        <result property="createdAt" column="created_at"/>
        <result property="updatedAt" column="updated_at"/>
        <result property="createdBy" column="created_by"/>
        <result property="updatedBy" column="updated_by"/>
        <result property="deletedAt" column="deleted_at"/>
        <result property="coverImage" column="cover_image"/>
        <result property="thumbnail" column="thumbnail"/>
        <result property="viewCount" column="view_count"/>
        <result property="likeCount" column="like_count"/>
        <result property="favoriteCount" column="favorite_count"/>
        <result property="commentCount" column="comment_count"/>
        <result property="likeStatus" column="like_status"/>
        <result property="favoriteStatus" column="favorite_status"/>
    </resultMap>

    <!-- PostListResl响应类结果映射 -->
    <resultMap id="PostListReslMap" type="chat.liuxin.liutech.resp.PostListResp">
        <id property="id" column="id"/>
        <result property="title" column="title"/>
        <result property="summary" column="summary"/>
        <result property="coverImage" column="cover_image"/>
        <result property="thumbnail" column="thumbnail"/>
        <result property="viewCount" column="view_count"/>
        <result property="likeCount" column="like_count"/>
        <result property="favoriteCount" column="favorite_count"/>
        <result property="commentCount" column="comment_count"/>
        <result property="likeStatus" column="like_status"/>
        <result property="favoriteStatus" column="favorite_status"/>
        <result property="status" column="status"/>
        <result property="createdAt" column="created_at"/>
        <result property="updatedAt" column="updated_at"/>
        <result property="deletedAt" column="deleted_at"/>
        <!-- 分类信息 -->
        <association property="category" javaType="chat.liuxin.liutech.resp.PostListResp$CategoryInfo">
            <id property="id" column="cat_id"/>
            <result property="name" column="cat_name"/>
        </association>
        <!-- 作者信息 -->
        <association property="author" javaType="chat.liuxin.liutech.resp.PostListResp$AuthorInfo">
            <id property="id" column="author_user_id"/>
            <result property="username" column="author_username"/>
            <result property="avatarUrl" column="author_avatar_url"/>
        </association>
        <!-- 标签信息（使用嵌套查询，避免主查询JOIN导致分页数量减少） -->
        <collection property="tags" ofType="chat.liuxin.liutech.resp.PostListResp$TagInfo" column="{postId=id}" select="selectTagInfosByPostId"/>
    </resultMap>

    <!-- PostDetailResl响应类结果映射 -->
    <resultMap id="PostDetailReslMap" type="chat.liuxin.liutech.resp.PostDetailResp">
        <id property="id" column="id"/>
        <result property="title" column="title"/>
        <result property="content" column="content"/>
        <result property="summary" column="summary"/>
        <result property="coverImage" column="cover_image"/>
        <result property="thumbnail" column="thumbnail"/>
        <result property="categoryId" column="category_id"/>
        <result property="status" column="status"/>
        <result property="viewCount" column="view_count"/>
        <result property="likeCount" column="like_count"/>
        <result property="favoriteCount" column="favorite_count"/>
        <result property="commentCount" column="comment_count"/>
        <result property="likeStatus" column="like_status"/>
        <result property="favoriteStatus" column="favorite_status"/>
        <result property="createdAt" column="created_at"/>
        <result property="updatedAt" column="updated_at"/>
        <!-- 分类信息 -->
        <association property="category" javaType="chat.liuxin.liutech.resp.PostDetailResp$CategoryInfo">
            <id property="id" column="category_info_id"/>
            <result property="name" column="category_name"/>
            <result property="description" column="category_description"/>
        </association>
        <!-- 作者信息 -->
        <association property="author" javaType="chat.liuxin.liutech.resp.PostDetailResp$AuthorInfo">
            <id property="id" column="author_info_id"/>
            <result property="username" column="author_username"/>
            <result property="avatarUrl" column="author_avatar_url"/>
        </association>
        <!-- 标签信息 -->
        <collection property="tags" ofType="chat.liuxin.liutech.resp.PostDetailResp$TagInfo">
            <id property="id" column="tag_id"/>
            <result property="name" column="tag_name"/>
        </collection>
    </resultMap>

    <!-- 基础查询SQL片段 -->
    <sql id="baseSelectSql">
        SELECT
            p.id,
            p.title,
            p.content,
            p.summary,
            p.cover_image,
            p.thumbnail,
            p.category_id,
            p.author_id,
            p.status,
            p.view_count,
            p.like_count,
            p.favorite_count,
            p.created_at,
            p.updated_at,
            p.created_by,
            p.updated_by,
            p.deleted_at,
            c.id as cat_id,
            c.name as cat_name,
            c.description as cat_description,
            u.id as author_user_id,
            u.username as author_username,
            u.email as author_email,
            u.avatar_url as author_avatar_url,
            t.id as tag_id,
            t.name as tag_name,
            (SELECT COUNT(*) FROM comments cm WHERE cm.post_id = p.id AND cm.deleted_at IS NULL) as comment_count
        FROM posts p
        LEFT JOIN categories c ON p.category_id = c.id
        LEFT JOIN users u ON p.author_id = u.id
        LEFT JOIN post_tags pt ON p.id = pt.post_id
        LEFT JOIN tags t ON pt.tag_id = t.id
        WHERE p.deleted_at IS NULL
    </sql>

    <!-- 分页查询文章列表 -->
    <select id="selectPostsWithDetails" resultMap="PostWithDetailsMap">
        SELECT
            p.id,
            p.title,
            p.content,
            p.summary,
            p.cover_image,
            p.thumbnail,
            p.category_id,
            p.author_id,
            p.status,
            p.view_count,
            p.like_count,
            p.created_at,
            p.updated_at,
            p.created_by,
            p.updated_by,
            p.deleted_at,
            c.id as cat_id,
            c.name as cat_name,
            c.description as cat_description,
            u.id as author_user_id,
            u.username as author_username,
            u.email as author_email,
            u.avatar_url as author_avatar_url,
            (SELECT COUNT(*) FROM comments cm WHERE cm.post_id = p.id AND cm.deleted_at IS NULL) as comment_count
        FROM posts p
        LEFT JOIN categories c ON p.category_id = c.id
        LEFT JOIN users u ON p.author_id = u.id
        WHERE p.deleted_at IS NULL
        <if test="status != null and status != ''">
            AND p.status = #{status}
        </if>
        <if test="status == null or status == ''">
            AND p.status = 'published'
        </if>
        <if test="authorId != null">
            AND p.author_id = #{authorId}
        </if>
        <if test="categoryId != null">
            AND p.category_id = #{categoryId}
        </if>
        <if test="tagId != null">
            AND EXISTS (SELECT 1 FROM post_tags pt2 WHERE pt2.post_id = p.id AND pt2.tag_id = #{tagId})
        </if>
        <if test="keyword != null and keyword != ''">
            AND (p.title LIKE CONCAT('%', #{keyword}, '%')
                 OR p.content LIKE CONCAT('%', #{keyword}, '%')
                 OR p.summary LIKE CONCAT('%', #{keyword}, '%'))
        </if>
        ORDER BY p.created_at DESC
    </select>

    <!-- 分页查询文章列表（包含用户点赞收藏状态） -->
    <select id="selectPostsWithDetailsAndUserStatus" resultMap="PostWithDetailsMap">
        SELECT
            p.id,
            p.title,
            p.content,
            p.summary,
            p.cover_image,
            p.thumbnail,
            p.category_id,
            p.author_id,
            p.status,
            p.view_count,
            p.like_count,
            p.favorite_count,
            p.created_at,
            p.updated_at,
            p.created_by,
            p.updated_by,
            p.deleted_at,
            c.id as cat_id,
            c.name as cat_name,
            c.description as cat_description,
            u.id as author_user_id,
            u.username as author_username,
            u.email as author_email,
            u.avatar_url as author_avatar_url,
            (SELECT COUNT(*) FROM comments cm WHERE cm.post_id = p.id AND cm.deleted_at IS NULL) as comment_count,
            CASE WHEN pl.is_like = 1 THEN 1 ELSE 0 END as like_status,
            CASE WHEN pf.is_favorite = 1 THEN 1 ELSE 0 END as favorite_status
        FROM posts p
        LEFT JOIN categories c ON p.category_id = c.id
        LEFT JOIN users u ON p.author_id = u.id
        LEFT JOIN post_likes pl ON p.id = pl.post_id AND pl.user_id = #{userId}
        LEFT JOIN post_favorites pf ON p.id = pf.post_id AND pf.user_id = #{userId}
        WHERE p.deleted_at IS NULL
        <if test="status != null and status != ''">
            AND p.status = #{status}
        </if>
        <if test="status == null or status == ''">
            AND p.status = 'published'
        </if>
        <if test="authorId != null">
            AND p.author_id = #{authorId}
        </if>
        <if test="categoryId != null">
            AND p.category_id = #{categoryId}
        </if>
        <if test="tagId != null">
            AND EXISTS (SELECT 1 FROM post_tags pt2 WHERE pt2.post_id = p.id AND pt2.tag_id = #{tagId})
        </if>
        <if test="keyword != null and keyword != ''">
            AND (p.title LIKE CONCAT('%', #{keyword}, '%')
                 OR p.content LIKE CONCAT('%', #{keyword}, '%')
                 OR p.summary LIKE CONCAT('%', #{keyword}, '%'))
        </if>
        ORDER BY p.created_at DESC
    </select>

    <!-- 根据ID查询文章详情 -->
    <select id="selectPostWithDetails" resultMap="PostWithDetailsMap">
        SELECT
            p.id,
            p.title,
            p.content,
            p.summary,
            p.cover_image,
            p.thumbnail,
            p.category_id,
            p.author_id,
            p.status,
            p.view_count,
            p.like_count,
            p.favorite_count,
            p.created_at,
            p.updated_at,
            p.created_by,
            p.updated_by,
            p.deleted_at,
            c.id as cat_id,
            c.name as cat_name,
            c.description as cat_description,
            u.id as author_user_id,
            u.username as author_username,
            u.email as author_email,
            u.avatar_url as author_avatar_url,
            t.id as tag_id,
            t.name as tag_name,
            (SELECT COUNT(*) FROM comments cm WHERE cm.post_id = p.id AND cm.deleted_at IS NULL) as comment_count,
            CASE WHEN pl.is_like = 1 THEN 1 ELSE 0 END as like_status,
            CASE WHEN pf.is_favorite = 1 THEN 1 ELSE 0 END as favorite_status
        FROM posts p
        LEFT JOIN categories c ON p.category_id = c.id
        LEFT JOIN users u ON p.author_id = u.id
        LEFT JOIN post_tags pt ON p.id = pt.post_id
        LEFT JOIN tags t ON pt.tag_id = t.id
        LEFT JOIN post_likes pl ON p.id = pl.post_id AND pl.user_id = #{userId}
        LEFT JOIN post_favorites pf ON p.id = pf.post_id AND pf.user_id = #{userId}
        WHERE p.deleted_at IS NULL
        AND p.id = #{id}
    </select>

    <!-- 查询热门文章 -->
    <select id="selectHotPosts" resultMap="PostWithDetailsMap">
        SELECT
            p.id,
            p.title,
            p.summary,
            p.cover_image,
            p.thumbnail,
            p.category_id,
            p.author_id,
            p.status,
            IFNULL(p.view_count, 0) as view_count,
            IFNULL(p.like_count, 0) as like_count,
            p.created_at,
            p.updated_at,
            c.id as cat_id,
            c.name as cat_name,
            c.description as cat_description,
            u.id as author_user_id,
            u.username as author_username,
            u.email as author_email,
            u.avatar_url as author_avatar_url,
            COUNT(cm.id) as comment_count
        FROM posts p
        LEFT JOIN categories c ON p.category_id = c.id
        LEFT JOIN users u ON p.author_id = u.id
        LEFT JOIN comments cm ON p.id = cm.post_id AND cm.deleted_at IS NULL
        WHERE p.deleted_at IS NULL
        AND p.status = 'published'
        GROUP BY p.id, p.title, p.summary, p.cover_image, p.thumbnail, p.category_id, p.author_id, p.status, p.view_count, p.like_count, p.created_at, p.updated_at,
                 c.id, c.name, c.description, u.id, u.username, u.email, u.avatar_url
        ORDER BY comment_count DESC, IFNULL(p.view_count, 0) DESC, IFNULL(p.like_count, 0) DESC, p.created_at DESC
        LIMIT #{limit}
    </select>

    <!-- 查询最新文章列表（返回PostListResl） -->
    <select id="selectLatestPostListResl" resultMap="PostListReslMap">
        SELECT
            p.id,
            p.title,
            p.summary,
            p.cover_image,
            p.thumbnail,
            p.category_id,
            p.author_id,
            p.status,
            p.view_count,
            p.like_count,
            p.favorite_count,
            p.created_at,
            p.updated_at,
            c.id as cat_id,
            c.name as cat_name,
            u.id as author_user_id,
            u.username as author_username,
            u.avatar_url as author_avatar_url,
            (SELECT COUNT(*) FROM comments cm WHERE cm.post_id = p.id AND cm.deleted_at IS NULL) as comment_count,
            <if test="userId != null">
                CASE WHEN pl.id IS NOT NULL THEN 1 ELSE 0 END as like_status,
                CASE WHEN pf.id IS NOT NULL THEN 1 ELSE 0 END as favorite_status
            </if>
            <if test="userId == null">
                0 as like_status,
                0 as favorite_status
            </if>
        FROM posts p
        LEFT JOIN categories c ON p.category_id = c.id
        LEFT JOIN users u ON p.author_id = u.id
        <if test="userId != null">
            LEFT JOIN post_likes pl ON p.id = pl.post_id AND pl.user_id = #{userId} AND pl.is_like = 1
            LEFT JOIN post_favorites pf ON p.id = pf.post_id AND pf.user_id = #{userId} AND pf.is_favorite = 1
        </if>
        WHERE p.deleted_at IS NULL AND p.status = 'published'
        ORDER BY p.created_at DESC
        LIMIT #{limit}
    </select>

    <!-- 分页查询文章列表（返回PostListResl） -->
    <select id="selectPostListResl" resultMap="PostListReslMap">
        SELECT
            p.id,
            p.title,
            p.summary,
            p.cover_image,
            p.thumbnail,
            p.category_id,
            p.author_id,
            p.status,
            p.view_count,
            p.like_count,
            p.favorite_count,
            p.created_at,
            p.updated_at,
            c.id as cat_id,
            c.name as cat_name,
            u.id as author_user_id,
            u.username as author_username,
            u.avatar_url as author_avatar_url,
            (SELECT COUNT(*) FROM comments cm WHERE cm.post_id = p.id AND cm.deleted_at IS NULL) as comment_count,
            <if test="userId != null">
                CASE WHEN pl.id IS NOT NULL THEN 1 ELSE 0 END as like_status,
                CASE WHEN pf.id IS NOT NULL THEN 1 ELSE 0 END as favorite_status
            </if>
            <if test="userId == null">
                0 as like_status,
                0 as favorite_status
            </if>
        FROM posts p
        LEFT JOIN categories c ON p.category_id = c.id
        LEFT JOIN users u ON p.author_id = u.id
        <if test="userId != null">
            LEFT JOIN post_likes pl ON p.id = pl.post_id AND pl.user_id = #{userId} AND pl.is_like = 1
            LEFT JOIN post_favorites pf ON p.id = pf.post_id AND pf.user_id = #{userId} AND pf.is_favorite = 1
        </if>
        WHERE p.deleted_at IS NULL
        <if test="categoryId != null">
            AND p.category_id = #{categoryId}
        </if>
        <if test="tagId != null">
            AND EXISTS (SELECT 1 FROM post_tags pt2 WHERE pt2.post_id = p.id AND pt2.tag_id = #{tagId})
        </if>
        <if test="keyword != null and keyword != ''">
            AND p.title LIKE CONCAT('%', #{keyword}, '%')
            <!-- OR p.content LIKE CONCAT('%', #{keyword}, '%') -->
        </if>
        <if test="status != null and status != ''">
            AND p.status = #{status}
        </if>
        <if test="authorId != null">
            AND p.author_id = #{authorId}
        </if>
        ORDER BY p.created_at DESC
    </select>

    <!-- 查询文章详情（返回PostDetailResl） -->
    <select id="selectPostDetailResl" resultMap="PostDetailReslMap">
        SELECT
            p.id,
            p.title,
            p.content,
            p.summary,
            p.cover_image,
            p.thumbnail,
            p.category_id,
            p.author_id,
            p.status,
            p.view_count,
            p.like_count,
            p.favorite_count,
            p.created_at,
            p.updated_at,
            c.id as category_info_id,
            c.name as category_name,
            c.description as category_description,
            u.id as author_info_id,
            u.username as author_username,
            u.email as author_email,
            u.avatar_url as author_avatar_url,
            u.bio as author_bio,
            t.id as tag_id,
            t.name as tag_name,
            (SELECT COUNT(*) FROM comments cm WHERE cm.post_id = p.id AND cm.deleted_at IS NULL) as comment_count,
            <if test="userId != null">
                CASE WHEN pl.id IS NOT NULL THEN 1 ELSE 0 END as like_status,
                CASE WHEN pf.id IS NOT NULL THEN 1 ELSE 0 END as favorite_status
            </if>
            <if test="userId == null">
                0 as like_status,
                0 as favorite_status
            </if>
        FROM posts p
        LEFT JOIN categories c ON p.category_id = c.id
        LEFT JOIN users u ON p.author_id = u.id
        LEFT JOIN post_tags pt ON p.id = pt.post_id
        LEFT JOIN tags t ON pt.tag_id = t.id
        <if test="userId != null">
            LEFT JOIN post_likes pl ON p.id = pl.post_id AND pl.user_id = #{userId} AND pl.is_like = 1
            LEFT JOIN post_favorites pf ON p.id = pf.post_id AND pf.user_id = #{userId} AND pf.is_favorite = 1
        </if>
        WHERE p.id = #{id} AND p.deleted_at IS NULL
    </select>

    <!-- 查询热门文章列表（返回PostListResl） -->
    <select id="selectHotPostListResl" resultMap="PostListReslMap">
        SELECT
            p.id,
            p.title,
            p.summary,
            p.cover_image,
            p.thumbnail,
            p.category_id,
            p.author_id,
            p.status,
            p.view_count,
            p.like_count,
            p.favorite_count,
            p.created_at,
            p.updated_at,
            c.id as cat_id,
            c.name as cat_name,
            u.id as author_user_id,
            u.username as author_username,
            u.avatar_url as author_avatar_url,
            t.id as tag_id,
            t.name as tag_name,
            (SELECT COUNT(*) FROM comments cm WHERE cm.post_id = p.id AND cm.deleted_at IS NULL) as comment_count,
            <if test="userId != null">
                CASE WHEN pl.id IS NOT NULL THEN 1 ELSE 0 END as like_status,
                CASE WHEN pf.id IS NOT NULL THEN 1 ELSE 0 END as favorite_status
            </if>
            <if test="userId == null">
                0 as like_status,
                0 as favorite_status
            </if>
        FROM posts p
        LEFT JOIN categories c ON p.category_id = c.id
        LEFT JOIN users u ON p.author_id = u.id
        <if test="userId != null">
            LEFT JOIN post_likes pl ON p.id = pl.post_id AND pl.user_id = #{userId} AND pl.is_like = 1
            LEFT JOIN post_favorites pf ON p.id = pf.post_id AND pf.user_id = #{userId} AND pf.is_favorite = 1
        </if>
        WHERE p.deleted_at IS NULL AND p.status = 'published'
        ORDER BY (p.view_count * 0.3 + p.like_count * 0.4 + p.favorite_count * 0.3) DESC
        LIMIT #{limit}
    </select>

    <!-- 查询最新文章列表（返回PostListResl） -->
    <select id="selectLatestPostListResl" resultMap="PostListReslMap">
        SELECT
            p.id,
            p.title,
            p.summary,
            p.cover_image,
            p.thumbnail,
            p.category_id,
            p.author_id,
            p.status,
            p.view_count,
            p.like_count,
            p.favorite_count,
            p.created_at,
            p.updated_at,
            c.id as category_id,
            c.name as category_name,
            u.id as author_id,
            u.username as author_username,
            u.avatar_url as author_avatar_url,
            (SELECT COUNT(*) FROM comments cm WHERE cm.post_id = p.id AND cm.deleted_at IS NULL) as comment_count,
            <if test="userId != null">
                CASE WHEN pl.id IS NOT NULL THEN 1 ELSE 0 END as like_status,
                CASE WHEN pf.id IS NOT NULL THEN 1 ELSE 0 END as favorite_status
            </if>
            <if test="userId == null">
                0 as like_status,
                0 as favorite_status
            </if>
        FROM posts p
        LEFT JOIN categories c ON p.category_id = c.id
        LEFT JOIN users u ON p.author_id = u.id
        <if test="userId != null">
            LEFT JOIN post_likes pl ON p.id = pl.post_id AND pl.user_id = #{userId} AND pl.is_like = 1
            LEFT JOIN post_favorites pf ON p.id = pf.post_id AND pf.user_id = #{userId} AND pf.is_favorite = 1
        </if>
        WHERE p.deleted_at IS NULL AND p.status = 'published'
        ORDER BY p.created_at DESC
        LIMIT #{limit}
    </select>


    <!-- 查询当前用户的收藏文章列表（返回PostListResl） -->
    <select id="selectFavoritePostList" resultMap="PostListReslMap">
        SELECT 
            p.id,
            p.title,
            p.summary,
            p.cover_image,
            p.thumbnail,
            p.view_count,
            p.like_count,
            p.favorite_count,
            (SELECT COUNT(*) FROM comments cm WHERE cm.post_id = p.id AND cm.deleted_at IS NULL) as comment_count,
            p.status,
            p.created_at,
            p.updated_at,
            p.deleted_at,
            -- 分类信息
            c.id as cat_id,
            c.name as cat_name,
            -- 作者信息
            u.id as author_user_id,
            u.username as author_username,
            u.avatar_url as author_avatar_url,
            -- 用户状态（收藏状态固定为1，点赞状态需要查询）
            CASE WHEN pl.id IS NOT NULL THEN 1 ELSE 0 END as like_status,
            1 as favorite_status
        FROM posts p
        INNER JOIN post_favorites pf ON p.id = pf.post_id AND pf.user_id = #{userId} AND pf.is_favorite = 1 AND pf.deleted_at IS NULL
        LEFT JOIN categories c ON p.category_id = c.id
        LEFT JOIN users u ON p.author_id = u.id
        LEFT JOIN post_likes pl ON p.id = pl.post_id AND pl.user_id = #{userId} AND pl.is_like = 1 AND pl.deleted_at IS NULL
        WHERE p.status = 'published' 
        AND p.deleted_at IS NULL
        <if test="keyword != null and keyword != ''">
            AND (p.title LIKE CONCAT('%', #{keyword}, '%') 
                 OR p.summary LIKE CONCAT('%', #{keyword}, '%'))
        </if>
        ORDER BY pf.created_at DESC
    </select>



    <!-- 根据分类ID查询文章数量 -->
    <select id="countPostsByCategory" resultType="java.lang.Integer">
        SELECT COUNT(*)
        FROM posts p
        WHERE p.category_id = #{categoryId}
        AND p.deleted_at IS NULL
    </select>

    <!-- 根据标签ID查询文章数量 -->
    <select id="countPostsByTag" resultType="java.lang.Integer">
        SELECT COUNT(DISTINCT p.id)
        FROM posts p
        INNER JOIN post_tags pt ON p.id = pt.post_id
        WHERE pt.tag_id = #{tagId}
        AND p.deleted_at IS NULL
    </select>

    <!-- 恢复已删除的文章（绕过逻辑删除限制） -->
    <update id="restorePostById">
        UPDATE posts
        SET deleted_at = NULL, updated_at = NOW()
        WHERE id = #{id} AND deleted_at IS NOT NULL
    </update>

    <!-- 插入文章 -->
    <insert id="insert" parameterType="chat.liuxin.liutech.model.Posts" useGeneratedKeys="true" keyProperty="id">
        INSERT INTO posts (
            title,
            content,
            summary,
            category_id,
            author_id,
            status,
            cover_image,
            thumbnail,
            view_count,
            like_count,
            created_at,
            updated_at,
            created_by,
            updated_by
        ) VALUES (
            #{title},
            #{content},
            #{summary},
            #{categoryId},
            #{authorId},
            #{status},
            #{coverImage},
            #{thumbnail},
            #{viewCount},
            #{likeCount},
            #{createdAt},
            #{updatedAt},
            #{createdBy},
            #{updatedBy}
        )
    </insert>

    <!-- 更新文章 -->
    <update id="updateById" parameterType="chat.liuxin.liutech.model.Posts">
        UPDATE posts SET
            title = #{title},
            content = #{content},
            summary = #{summary},
            category_id = #{categoryId},
            status = #{status},
            cover_image = #{coverImage},
            thumbnail = #{thumbnail},
            updated_at = #{updatedAt},
            updated_by = #{updatedBy}
        WHERE id = #{id}
        AND deleted_at IS NULL
    </update>

    <!-- 软删除文章 -->
    <update id="deleteById">
        UPDATE posts SET
            deleted_at = #{deletedAt},
            updated_by = #{updatedBy}
        WHERE id = #{id}
        AND deleted_at IS NULL
    </update>

    <!-- 更新文章状态 -->
    <update id="updateStatus">
        UPDATE posts SET
            status = #{status},
            updated_at = #{updatedAt},
            updated_by = #{updatedBy}
        WHERE id = #{id}
        AND deleted_at IS NULL
    </update>

    <!-- 根据ID查询文章（不包含关联信息） -->
    <select id="selectById" resultType="chat.liuxin.liutech.model.Posts">
        SELECT
            id,
            title,
            content,
            summary,
            category_id,
            author_id,
            status,
            created_at,
            updated_at,
            created_by,
            updated_by,
            deleted_at
        FROM posts
        WHERE id = #{id}
        AND deleted_at IS NULL
    </select>

    <!-- 检查文章是否存在 -->
    <select id="existsById" resultType="java.lang.Boolean">
        SELECT COUNT(*) > 0
        FROM posts
        WHERE id = #{id}
        AND deleted_at IS NULL
    </select>

    <!-- 根据用户ID和状态统计文章数量 -->
    <select id="countPostsByUserIdAndStatus" resultType="java.lang.Integer">
        SELECT COUNT(*)
        FROM posts p
        WHERE p.author_id = #{userId}
        AND p.status = #{status}
        AND p.deleted_at IS NULL
    </select>

    <!-- 获取用户最后发文时间 -->
    <select id="getLastPostTimeByUserId" resultType="java.util.Date">
        SELECT MAX(p.created_at)
        FROM posts p
        WHERE p.author_id = #{userId}
        AND p.status = 'published'
        AND p.deleted_at IS NULL
    </select>

    <!-- 统计全站已发布文章数量 -->
    <select id="countPublishedPosts" resultType="java.lang.Integer">
        SELECT COUNT(*)
        FROM posts p
        WHERE p.status = 'published'
        AND p.deleted_at IS NULL
    </select>

    <!-- 统计全站文章总浏览量 -->
    <select id="countAllViews" resultType="java.lang.Long">
        SELECT IFNULL(SUM(p.view_count), 0)
        FROM posts p
        WHERE p.status = 'published'
        AND p.deleted_at IS NULL
    </select>

    <!-- 统计用户所有文章的浏览量总和 -->
    <select id="countViewsByUserId" resultType="java.lang.Long">
        SELECT IFNULL(SUM(p.view_count), 0)
        FROM posts p
        WHERE p.author_id = #{userId}
        AND p.status = 'published'
        AND p.deleted_at IS NULL
    </select>

    <!-- 分页查询文章列表（返回PostListResl）- 已上移至文件底部，保持逻辑清晰 -->

    <!-- 嵌套查询：根据文章ID获取标签信息（用于PostListReslMap.tags） -->
    <select id="selectTagInfosByPostId" resultType="chat.liuxin.liutech.resp.PostListResp$TagInfo">
        SELECT
            t.id AS id,
            t.name AS name
        FROM tags t
        INNER JOIN post_tags pt ON t.id = pt.tag_id
        WHERE pt.post_id = #{postId}
        ORDER BY t.name
    </select>

    <!-- 管理端分页查询文章列表（返回PostListResl） -->
    <select id="selectPostListForAdmin" resultMap="PostListReslMap">
        SELECT
            p.id,
            p.title,
            p.summary,
            p.cover_image,
            p.thumbnail,
            p.category_id,
            p.author_id,
            p.status,
            p.view_count,
            p.like_count,
            p.favorite_count,
            p.created_at,
            p.updated_at,
            p.deleted_at,
            c.id as cat_id,
            c.name as cat_name,
            u.id as author_user_id,
            u.username as author_username,
            u.avatar_url as author_avatar_url,
            (SELECT COUNT(*) FROM comments cm WHERE cm.post_id = p.id AND cm.deleted_at IS NULL) as comment_count,
            0 as like_status,
            0 as favorite_status
        FROM posts p
        LEFT JOIN categories c ON p.category_id = c.id
        LEFT JOIN users u ON p.author_id = u.id
        <where>
            <if test="includeDeleted == null or includeDeleted == false">
                p.deleted_at IS NULL
            </if>
            <if test="status != null and status != ''">
                AND p.status = #{status}
            </if>
            <if test="authorId != null">
                AND p.author_id = #{authorId}
            </if>
            <if test="categoryId != null">
                AND p.category_id = #{categoryId}
            </if>
            <if test="keyword != null and keyword != ''">
                AND p.title LIKE CONCAT('%', #{keyword}, '%')
            </if>
        </where>
        ORDER BY p.created_at DESC
    </select>

    <!-- 管理端统计文章总数 -->
    <select id="countPostsForAdmin" resultType="java.lang.Integer">
        SELECT COUNT(DISTINCT p.id)
        FROM posts p
        <where>
            <if test="includeDeleted == null or includeDeleted == false">
                p.deleted_at IS NULL
            </if>
            <if test="status != null and status != ''">
                AND p.status = #{status}
            </if>
            <if test="authorId != null">
                AND p.author_id = #{authorId}
            </if>
            <if test="categoryId != null">
                AND p.category_id = #{categoryId}
            </if>
            <if test="keyword != null and keyword != ''">
                AND p.title LIKE CONCAT('%', #{keyword}, '%')
            </if>
        </where>
    </select>

    <!-- 根据分类ID列表物理删除文章 -->
    <delete id="deletePostsByCategoryIds">
        DELETE FROM posts
        WHERE category_id IN
        <foreach collection="categoryIds" item="categoryId" open="(" separator="," close=")">
            #{categoryId}
        </foreach>
    </delete>

    <!-- 根据标签ID列表删除文章标签关联关系 -->
    <delete id="deletePostTagsByTagIds">
        DELETE FROM post_tags
        WHERE tag_id IN
        <foreach collection="tagIds" item="tagId" open="(" separator="," close=")">
            #{tagId}
        </foreach>
    </delete>

    <!-- 根据文章ID物理删除文章 -->
    <delete id="permanentDeleteById">
        DELETE FROM posts WHERE id = #{id}
    </delete>

    <!-- 根据文章ID列表物理删除文章 -->
    <delete id="permanentDeleteByIds">
        DELETE FROM posts
        WHERE id IN
        <foreach collection="ids" item="id" open="(" separator="," close=")">
            #{id}
        </foreach>
    </delete>

</mapper>
